---
title: "Adding new families to glmmTMB"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adding new families to glmmTMB}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
---

```{r load_lib,echo=FALSE}
library(glmmTMB)
knitr::opts_chunk$set(eval = if (isTRUE(exists("params"))) params$EVAL else FALSE)
```

## modify glmmTMB.cpp

- add to the section `enum valid_family`:

```{Rcpp, eval = FALSE}
zo_truncated_poisson_family = 410,
```

- add a case to the giant `switch` statement that handles the conditional likelihood (search for `// Observation likelihood`): in this case we can most easily do this by modifying the case for the zero-truncated Poisson family (`case truncated_poisson_family`):
   - `mu(i)` is the value of the location parameter for the current observation
   - `phi(i)` is the value of the dispersion parameter for the current observation
   - use logspace addition/subtraction if possible
   - if you want to be able to simulate data, add a `SIMULATE{}` condition that samples a random deviate from your distribution

```{Rcpp, eval = FALSE}
      case zo_truncated_poisson_family:
        log_nzprob = logspace_sub(Type(0), -mu(i));  // log(1-exp(-mu(i)));
	log_nzprob = logspace_sub(log_nzprob, log(mu(i)) - mu(i));
        tmp_loglik = dpois(yobs(i), mu(i), true) - log_nzprob;
        tmp_loglik = zt_lik_nearzero(yobs(i), tmp_loglik);
        SIMULATE{
		yobs(i) = glmmtmb::rtruncated_poisson(1, asDouble(mu(i)));
        }
        break;
```

## modifying family.R

Might be able to get away with specifying `family=` as a list, but ...

```{r eval = FALSE}
#' @rdname nbinom2
#' @export
zo_truncated_poisson <- function(link="log") {
    r <- list(family="zo_truncated_poisson",
              variance=function(lambda) {
                  stop("haven't implemented variance function")
                  ## (lambda+lambda^2)/(1-exp(-lambda)) - lambda^2/((1-exp(-lambda))^2)
              })
    return(make_family(r,link))
}
```

## modifying glmmTMB.R

The R code *may* not need to be updated, depending on the details of the family you are adding. Again, it's best to try to work by analogy with the closest family to the one you're adding. In this case, the only occurrence of `truncated_poisson` in `glmmTMB.R` is in the definition of which families have no dispersion parameter:

```{r, eval = FALSE}
.noDispersionFamilies <- c("binomial", "poisson", "truncated_poisson",
                           "zo_truncated_poisson")
```

## updating NAMESPACE

`devtools::document()`

## updating enum.R

The R file that keeps the C++ and R code in sync with respect to which families are available and which numeric code corresponds to which family is `enum.R`. **Do not edit this file by hand**: instead, run `make enum-update`

## make up a test

```{r}
library(glmmTMB)
set.seed(101)
dd <- data.frame(y = rpois(500, exp(3)))
dd <- dd[dd$y>1,,drop=FALSE]
glmmTMB(y ~ 1, family = "zo_truncated_poisson", data = dd)
```
